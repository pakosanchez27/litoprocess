document.addEventListener("DOMContentLoaded",()=>{const i=document.getElementById("tipo_documento"),n=document.getElementById("area_codigo"),t=document.getElementById("consecutivo"),s=document.getElementById("es_fsc"),l=document.getElementById("codigo");function o(){const c=i.value||"",a=n.value||"",d=(t.value||"").padStart(3,"0"),e=s.checked?"FSC":"";if(c&&a&&d){const r=["L",c];e&&r.push(e),r.push(a,d),l.value=r.join("-")}else l.value=""}[i,n,t,s].forEach(c=>{c.addEventListener("input",o),c.addEventListener("change",o)}),o()});document.addEventListener("DOMContentLoaded",function(){const i=document.getElementById("ref_tag_input"),n=document.getElementById("ref_tag_box"),t=document.getElementById("referencias_normativas");let s=[];function l(){n.querySelectorAll(".chip").forEach(o=>o.remove()),s.forEach((o,c)=>{const a=document.createElement("span");a.className="chip badge bg-primary d-flex align-items-center",a.style.gap="6px",a.style.padding="6px 10px",a.innerHTML=`
        <span>${o}</span>
        <button type="button" class="btn-close btn-close-white btn-sm" aria-label="Eliminar" data-index="${c}"></button>
      `,a.querySelector("button").addEventListener("click",()=>{s.splice(c,1),l()}),n.insertBefore(a,i)}),t.value=s.join(",")}i.addEventListener("keydown",function(o){if(o.key==="Enter"||o.key===","||o.key==="Tab"){o.preventDefault();const c=this.value.trim();c&&!s.includes(c)&&(s.push(c),l()),this.value=""}else o.key==="Backspace"&&this.value===""&&(s.pop(),l())}),t.value&&(s=t.value.split(",").map(o=>o.trim()).filter(Boolean),l())});document.addEventListener("DOMContentLoaded",function(){const i=document.getElementById("termino"),n=document.getElementById("definicion"),t=document.getElementById("addDefinicion"),s=document.getElementById("definiciones-list"),l=document.getElementById("definiciones_json");let o=[];if(l.value)try{o=JSON.parse(l.value)}catch{o=[]}function c(){s.innerHTML="",o.forEach((a,d)=>{const e=document.createElement("li");e.className="list-group-item d-flex justify-content-between align-items-center",e.innerHTML=`
        <div><strong>${a.termino}</strong>: ${a.definicion}</div>
        <button type="button" class="btn btn-sm btn-danger" title="Eliminar">✖</button>
      `,e.querySelector("button").addEventListener("click",()=>{o.splice(d,1),c()}),s.appendChild(e)}),l.value=JSON.stringify(o)}t.addEventListener("click",()=>{const a=i.value.trim(),d=n.value.trim();!a||!d||(o.push({termino:a,definicion:d}),i.value="",n.value="",c())}),c()});(function(){const i=(e,r=document)=>r.querySelector(e),n=(e,r=document)=>Array.from(r.querySelectorAll(e)),t={form:i("#procedimientoForm"),pasosContainer:i("#pasosContainer"),btnAgregarPaso:i("#btnAgregarPaso")};let s=0;function l(e={responsable:"",actividad:""}){const r=`act-${s++}`,u=document.createElement("div");u.className="col-12 paso",u.setAttribute("draggable","true"),u.innerHTML=`
      <div class="card border shadow-sm p-3 mb-2">
        <div class="row g-3 align-items-start">
          <div class="col-md-4">
            <label class="form-label fw-semibold">Responsable</label>
            <input type="text" name="responsable" class="form-control"
                   placeholder="Nombre o puesto responsable"
                   value="${(e.responsable||"").replace(/"/g,"&quot;")}">
          </div>

          <div class="col-md-7">
            <label class="form-label fw-semibold">Actividad</label>
            <textarea id="${r}" name="actividad" class="form-control" rows="3"
                      placeholder="Describa la actividad...">${(e.actividad||"").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</textarea>

            <div class="d-flex justify-content-between align-items-center mt-2">
              <button type="button" class="btn btn-outline-primary btn-sm"
                      data-bs-toggle="tooltip" data-bs-placement="top"
                      title="<i class='bx bx-pencil-sparkles bx-xs'></i> <span>Mejorar redacción</span>"
                      onclick="redactarActividadIA('${r}')">
                <i class="bx bx-pencil-sparkles"></i> Mejorar redacción
              </button>
              <small class="text-muted"><i class="bx bx-move-vertical"></i> Arrastra para reordenar</small>
            </div>
          </div>

          <div class="col-md-1 d-flex justify-content-end align-items-start">
            <button class="btn btn-outline-danger btn-sm" type="button" data-role="del-step"
                    data-bs-toggle="tooltip" data-bs-placement="top" title="Eliminar paso">
              <i class="bx bx-trash"></i>
            </button>
          </div>
        </div>
      </div>
    `,a(u,t.pasosContainer),t.pasosContainer.appendChild(u),c(t.pasosContainer)}function o(){return n(".paso",t.pasosContainer).map(e=>{const r=e.querySelector('input[name="responsable"]')?.value.trim()||"",u=e.querySelector('textarea[name="actividad"]')?.value.trim()||"";return!r&&!u?null:{responsable:r,actividad:u}}).filter(Boolean)}function c(e){if(e.querySelector(".paso"))e.querySelector(".empty")?.remove();else if(!e.querySelector(".empty")){const r=document.createElement("div");r.className="empty text-muted small fst-italic text-center p-2",r.textContent="Sin pasos. Agrega al menos uno.",e.appendChild(r)}}function a(e,r){e.addEventListener("dragstart",u=>{e.classList.add("ghost"),u.dataTransfer.setData("text/plain","x")}),e.addEventListener("dragend",()=>e.classList.remove("ghost")),r.addEventListener("dragover",u=>{u.preventDefault();const m=d(r,u.clientY);m==null?r.appendChild(e):r.insertBefore(e,m)})}function d(e,r){return[...e.querySelectorAll(".paso:not(.ghost)")].reduce((m,p)=>{const g=p.getBoundingClientRect(),f=r-g.top-g.height/2;return f<0&&f>m.offset?{offset:f,element:p}:m},{offset:Number.NEGATIVE_INFINITY}).element}t.pasosContainer?.addEventListener("click",e=>{const r=e.target.closest("[data-role]");r?.dataset.role==="del-step"&&(r.closest(".paso")?.remove(),c(t.pasosContainer))}),t.btnAgregarPaso?.addEventListener("click",()=>l()),(function(){const r=document.getElementById("desarrollo_json");if(!(!r||!r.value)){try{(JSON.parse(r.value)||[]).forEach(m=>l(m))}catch{}c(t.pasosContainer)}})(),window.agregarPaso=l,window.readDesarrollo=o})();(function(){const i=(a,d=document)=>d.querySelector(a),n=(a,d=document)=>Array.from(d.querySelectorAll(a)),t={container:i("#politicasContainer"),addBtn:i("#btnAgregarPolitica"),hidden:i("#politicas_json")};let s=0;function l(a=""){const d=`politica-${s++}`,e=document.createElement("div");e.className="card mb-2 border shadow-sm p-3 politica-item",e.innerHTML=`
      <div class="d-flex flex-column gap-2">
        <div>
          <label for="${d}" class="form-label fw-semibold">Política</label>
          <textarea id="${d}" name="politica_${s}" class="form-control" rows="3"
                    placeholder="Describe una política...">${a}</textarea>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-1">
          <button type="button" class="btn btn-outline-primary btn-sm"
                  data-bs-toggle="tooltip" data-bs-placement="top"
                  title="<i class='bx bx-pencil-sparkles bx-xs'></i> <span>Mejorar redacción</span>"
                  onclick="redactarPoliticasIA('${d}')">
            <i class="bx bx-pencil-sparkles"></i> Mejorar redacción
          </button>
          <button type="button" class="btn btn-outline-danger btn-sm" data-role="delete-politica"
                  data-bs-toggle="tooltip" data-bs-placement="top" title="Eliminar política">
            <i class="bx bx-trash"></i>
          </button>
        </div>
      </div>
    `,t.container.appendChild(e),c()}function o(){return n(".politica-item textarea",t.container).map(a=>a.value.trim()).filter(Boolean)}function c(){t.hidden&&(t.hidden.value=JSON.stringify(o()))}t.container?.addEventListener("click",a=>{const d=a.target.closest('[data-role="delete-politica"]');d&&(d.closest(".politica-item")?.remove(),c())}),t.addBtn?.addEventListener("click",()=>l()),(function(){if(!(!t.hidden||!t.hidden.value))try{(JSON.parse(t.hidden.value)||[]).forEach(e=>l(e))}catch{}})(),window.agregarPolitica=l,window.readPoliticas=o})();document.addEventListener("DOMContentLoaded",()=>{const i=document.getElementById("toggleIndicadores"),n=document.getElementById("indicadoresSection"),t=document.getElementById("addIndicador"),s=document.getElementById("indicadores-list"),l=document.getElementById("indicadores_json");let o=[];function c(){s.innerHTML="",o.forEach((a,d)=>{const e=document.createElement("li");e.className="list-group-item d-flex justify-content-between align-items-center",e.innerHTML=`
        <span><strong>${a.indicador}</strong> — Meta: ${a.meta}, Monitoreo: ${a.monitoreo}, Responsable: ${a.responsable}</span>
        <button class="btn btn-sm btn-outline-danger" type="button">❌</button>
      `,e.querySelector("button").addEventListener("click",()=>{o.splice(d,1),l.value=JSON.stringify(o),c()}),s.appendChild(e)})}if(i.addEventListener("change",()=>{n.style.display=i.checked?"block":"none",i.checked||(o=[],l.value="[]",c())}),t?.addEventListener("click",()=>{const a=document.getElementById("indicador").value.trim(),d=document.getElementById("meta").value.trim(),e=document.getElementById("monitoreo").value.trim(),r=document.getElementById("responsable").value.trim();if(!a||!d||!e||!r){alert("Por favor completa todos los campos del indicador.");return}const u={indicador:a,meta:d,monitoreo:e,responsable:r};o.push(u),l.value=JSON.stringify(o),c(),["indicador","meta","monitoreo","responsable"].forEach(m=>document.getElementById(m).value="")}),l.value)try{const a=JSON.parse(l.value);Array.isArray(a)&&a.length&&(o=a,i.checked=!0,n.style.display="block",c())}catch{}});document.addEventListener("DOMContentLoaded",()=>{document.getElementById("procedimientoForm").addEventListener("submit",()=>{if(typeof readDesarrollo=="function"){const n=readDesarrollo();document.getElementById("desarrollo_json").value=JSON.stringify(n||[])}if(typeof readPoliticas=="function"){const n=readPoliticas();document.getElementById("politicas_json").value=JSON.stringify(n||[])}})});const h=i=>{const n=i.split(/—| - | – /);if(n.length>=2){const t=n[0].trim(),s=n.slice(1).join("—").trim();return{codigo:t,nombre:s}}return{codigo:"",nombre:i.trim()}};function I(i){if(!i)return[];try{const n=JSON.parse(i);if(Array.isArray(n))return n.filter(t=>t&&(t.codigo||t.nombre)).map(t=>({codigo:t.codigo??t.nombre??"",nombre:t.nombre??t.codigo??""}));if(typeof n=="string"){try{const t=JSON.parse(n);if(Array.isArray(t))return t.filter(s=>s&&(s.codigo||s.nombre)).map(s=>({codigo:s.codigo??s.nombre??"",nombre:s.nombre??s.codigo??""}))}catch{}return n.split(",").map(t=>t.trim()).filter(Boolean).map(t=>({codigo:t,nombre:t}))}}catch{return i.split(",").map(n=>n.trim()).filter(Boolean).map(n=>({codigo:n,nombre:n}))}return[]}function E({inputId:i,chipsId:n,hiddenId:t,feedbackId:s,min:l=1}){const o=document.getElementById(i),c=document.getElementById(n),a=document.getElementById(t),d=document.getElementById(s);if(!o||!c||!a)return;let e=[];try{e=I(a.value).filter(m=>m&&(m.codigo||m.nombre))}catch{e=[]}const r=()=>{c.querySelectorAll(".chip").forEach(p=>p.remove()),e.forEach((p,g)=>{const f=document.createElement("span");f.className="chip badge bg-primary d-flex align-items-center",f.style.gap="6px",f.style.padding="6px 10px";const b=p.codigo?`[${p.codigo}] ${p.nombre}`:p.nombre;f.innerHTML=`
        <span>${b}</span>
        <button type="button" class="btn-close btn-close-white btn-sm" aria-label="Eliminar"></button>
      `,f.querySelector("button").addEventListener("click",()=>{e.splice(g,1),r()}),c.appendChild(f)}),a.value=JSON.stringify(e);const m=e.length<l;d&&(d.style.display=m?"block":"none"),o.classList.toggle("is-invalid",m)},u=()=>{const m=(o.value||"").trim();if(!m)return;const p=h(m),g=p.codigo?p.codigo+"|"+p.nombre:p.nombre;e.some(b=>(b.codigo?b.codigo+"|"+b.nombre:b.nombre)===g)||(e.push(p),r()),o.value=""};return o.addEventListener("keydown",m=>{(m.key==="Enter"||m.key==="Tab"||m.key===",")&&(m.preventDefault(),u()),m.key==="Backspace"&&o.value===""&&e.length&&(e.pop(),r())}),o.addEventListener("change",u),r(),{get value(){return e.slice()},validate(){return e.length>=l}}}const v=E({inputId:"ref_input",chipsId:"chips_referencias",hiddenId:"referencias_json",feedbackId:"referencias_feedback",min:1}),y=E({inputId:"fmt_input",chipsId:"chips_formatos",hiddenId:"formatos_json",feedbackId:"formatos_feedback",min:1});document.getElementById("procedimientoForm")?.addEventListener("submit",i=>{let n=!0;v&&!v.validate()&&(n=!1),y&&!y.validate()&&(n=!1),n||(i.preventDefault(),i.stopPropagation(),(document.querySelector(".is-invalid")||document.getElementById("referencias_feedback"))?.scrollIntoView({behavior:"smooth",block:"center"}))});document.addEventListener("DOMContentLoaded",()=>{const i=document.getElementById("tipo_documento"),n=document.getElementById("area_codigo"),t=document.getElementById("consecutivo"),s=document.getElementById("es_fsc"),l=document.getElementById("codigo"),o=document.getElementById("elaboro_area"),c={DG:"Dirección General",DO:"Dirección Operativa",CA:"Control de Calidad",CO:"Contabilidad",FA:"Facturación",SI:"Sistemas IT",MT:"Mantenimiento",VE:"Ventas",OP:"Operaciones",EN:"Entregas / Envíos",LI:"Acabado Litografía",MA:"Acabado Manual",AL:"Almacén",ID:"Integración y Desarrollo",OF:"Oficinas"};function a(){const e=i.value||"",r=n.value||"",u=t.value.padStart(3,"0"),m=s.checked?"FSC":"";if(e&&r&&u){let p=["L",e];m&&p.push(m),p.push(r,u),l.value=p.join("-")}else l.value=""}function d(){const e=n.value.trim().toUpperCase();c[e]?o.value=c[e]:o.value=""}[i,n,t,s].forEach(e=>{e.addEventListener("input",a),e.addEventListener("change",a)}),n.addEventListener("input",d),n.addEventListener("change",d)});document.addEventListener("DOMContentLoaded",function(){const i=document.getElementById("btnGenerarPDF"),n=document.getElementById("mermaidPreview");function t(){if(!n)return;const c=n.querySelector("img");c&&c.complete&&c.naturalWidth>0?(i.disabled=!1,i.classList.remove("opacity-50","cursor-not-allowed")):(i.disabled=!0,i.classList.add("opacity-50","cursor-not-allowed"))}const s=new MutationObserver(()=>t());n&&s.observe(n,{childList:!0,subtree:!0});const l=setInterval(t,500);t();const o=setInterval(()=>{i.disabled||(clearInterval(l),clearInterval(o))},1e3)});
