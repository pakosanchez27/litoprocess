function*v(t){const a=t.split(/\n\n/);for(const l of a){if(!l)continue;const o=l.split(`
`).filter(e=>e.startsWith("data:"));if(!o.length)continue;const f=o.map(e=>e.slice(5).trim()).join(`
`);if(!(!f||f==="[DONE]"))try{const e=JSON.parse(f);if(e.type==="response.output_text.delta"&&e.delta){yield e.delta;continue}if(e.type==="message.delta"&&e?.delta?.content?.[0]?.text){yield e.delta.content[0].text;continue}const i=e?.candidates?.[0]?.content?.parts?.[0]?.text;i&&(yield i)}catch{}}}const s=new Map;async function d({textareaId:t="objetivo",type:a="objetivo",url:l="/ia/redactar"}={}){const o=document.getElementById(t);if(!o)throw new Error(`No se encontró textarea #${t}`);const e=document.querySelector('meta[name="csrf-token"]')?.content||"",i=o.value,w=o.getAttribute("placeholder")||"";o.value="",o.setAttribute("placeholder","Mejorando redacción…");let c="";const y=s.get(t);y&&y.abort();const b=new AbortController;s.set(t,b);try{const n=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json",Accept:"text/event-stream",...e?{"X-CSRF-TOKEN":e}:{}},credentials:"same-origin",body:JSON.stringify({text:i,type:a}),signal:b.signal});if(!n.ok||!n.body)throw new Error("No se pudo abrir el stream");const A=n.body.getReader(),h=new TextDecoder;let r="";for(;;){const{value:p,done:m}=await A.read();if(m)break;r+=h.decode(p,{stream:!0}).replace(/\r\n/g,`
`);const u=r.lastIndexOf(`

`);if(u>=0){const g=r.slice(0,u+2);r=r.slice(u+2);for(const j of v(g))c+=j,o.value=c,window.updateCounters&&window.updateCounters(),window.persist&&window.persist()}}if(r)for(const p of v(r))c+=p,o.value=c;return o.setAttribute("placeholder",w),s.delete(t),c}catch(n){throw n.name!=="AbortError"&&(console.error(n),o.value=i),o.setAttribute("placeholder",w),s.delete(t),n}}window.redactarObjetivoIA=()=>d({textareaId:"objetivo",type:"objetivo"});window.redactarAlcanceIA=()=>d({textareaId:"alcance",type:"alcance"});window.mejorarDefinicionIA=()=>d({textareaId:"definicion",type:"definicion"});window.redactarActividadIA=t=>d({textareaId:t,type:"actividad"});window.redactarPoliticasIA=t=>d({textareaId:t,type:"politicas"});window.cancelRedaccionIA=t=>{const a=s.get(t);a&&a.abort()};
