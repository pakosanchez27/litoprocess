const c=e=>document.getElementById(e);(function(){const e=c("mermaidPreview"),o=c("btnFullscreen");if(!e||!o)return;async function s(){try{await(e.requestFullscreen?.()||e.webkitRequestFullscreen?.())}catch(a){console.error("No se pudo entrar a fullscreen:",a)}}async function t(){try{await(document.exitFullscreen?.()||document.webkitExitFullscreen?.())}catch(a){console.error("No se pudo salir de fullscreen:",a)}}function n(){const a=!!(document.fullscreenElement||document.webkitFullscreenElement);o.textContent=a?"⤢ Salir de pantalla completa":"⛶ Pantalla completa"}o.addEventListener("click",()=>{!!(document.fullscreenElement||document.webkitFullscreenElement)?t():s()}),e.addEventListener("dblclick",()=>{!!(document.fullscreenElement||document.webkitFullscreenElement)?t():s()}),document.addEventListener("fullscreenchange",n),document.addEventListener("webkitfullscreenchange",n),n()})();function v(){return(typeof readDesarrollo=="function"?readDesarrollo()||[]:[]).map(t=>t&&typeof t.actividad=="string"?t.actividad.trim():"").filter(Boolean).map((t,n)=>`Paso ${n+1}: ${t}`).join(", ")}async function E(){const e=c("mermaidPreview"),o=c("mermaidError"),s=c("mermaidCode"),t=c("btnGenerarCodigo");o&&(o.style.display="none"),e&&(e.classList.add("is-loading"),e.innerHTML=`
      <div class="mmd-spinner" role="status" aria-live="polite" aria-label="Generando diagrama…"></div>
      <div class="mmd-loading-text">Generando diagrama…</div>
    `),t&&(t.classList.add("is-disabled"),t.setAttribute("disabled",""));try{const n=typeof readDesarrollo=="function"?readDesarrollo()||[]:[];if(!Array.isArray(n)||n.length===0){if(e&&e.classList.remove("is-loading"),t&&(t.classList.remove("is-disabled"),t.removeAttribute("disabled")),typeof window.createModal=="function"){const r=window.createModal({title:"Faltan pasos",text:"Agrega al menos un paso en el desarrollo del procedimiento antes de generar el diagrama.",confirmText:"Agregar paso"});await r.show();const y=document.getElementById("modal-go-add");y&&y.addEventListener("click",()=>{r.close();const p=document.getElementById("btnAgregarPaso");p&&(p.scrollIntoView({behavior:"smooth",block:"center"}),p.focus())})}else window.Notify&&typeof window.Notify.missingSteps=="function"?await window.Notify.missingSteps():await(async()=>alert("Faltan pasos. Agrega al menos un paso en el desarrollo del procedimiento antes de generar el diagrama."))();return}const a=document.getElementById("procedimientoForm")||document.querySelector("form"),l=typeof readDesarrollo=="function"?readDesarrollo():[];let i=document.getElementById("desarrollo_json");a?(i||(i=document.createElement("input"),i.type="hidden",i.name="desarrollo",i.id="desarrollo_json",a.appendChild(i)),i.value=JSON.stringify(l),console.log("🧩 Pasos sincronizados antes de generar diagrama:",l)):console.warn("No se encontró el formulario para sincronizar pasos. Pasos:",l);const f=await Promise.resolve(v()),m=await fetch("/ia/diagrama",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""},body:JSON.stringify({pasos:f})});let u={};try{u=await m.json()}catch{u={}}const d=u?.response||'flowchart TD; A["Error al generar diagrama"];';s&&(s.value=d);const g=await fetch("https://n8n.srv914565.hstgr.cloud/webhook/generador-diagrama",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pasos:d})});if(!g.ok)throw new Error(`Error en webhook: ${g.status}`);const w=await g.blob(),b=URL.createObjectURL(w);if(e){e.classList.remove("is-loading"),e.innerHTML="";const r=document.createElement("img");r.src=b,r.alt="Diagrama Mermaid generado",r.style.maxWidth="100%",r.style.borderRadius="8px",r.style.background="#fff",r.style.boxShadow="0 0 8px rgba(0,0,0,0.1)",e.appendChild(r)}}catch(n){e&&(e.classList.remove("is-loading"),e.textContent="—"),o&&(o.textContent=n?.message||String(n),o.style.display="block"),console.error("renderDiagramaIA error:",n)}finally{e&&e.classList.remove("is-loading"),t&&(t.classList.remove("is-disabled"),t.removeAttribute("disabled"))}}(function(){const e=document.getElementById("btnGenerarPDF");e&&e.addEventListener("click",async function(o){const s=this.closest("form"),t=document.getElementById("mermaidPreview"),n=document.getElementById("diagrama_png"),a=t?.querySelector("img");if(!a){console.warn("⚠️ No hay diagrama generado aún, se enviará sin imagen.");return}o.preventDefault();try{const l=a.src,i=await fetch(l).then(m=>m.blob()),f=await new Promise((m,u)=>{const d=new FileReader;d.onloadend=()=>m(d.result),d.onerror=u,d.readAsDataURL(i)});n&&(n.value=f),s&&s.submit()}catch(l){console.error("Error al adjuntar el diagrama al formulario:",l),alert("Hubo un problema al adjuntar el diagrama. Intenta de nuevo.")}})})();window.renderDiagramaIA=E;
